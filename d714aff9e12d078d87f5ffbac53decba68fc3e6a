{
  "comments": [
    {
      "key": {
        "uuid": "c6fd06eb_121ea1f1",
        "filename": "/COMMIT_MSG",
        "patchSetId": 10
      },
      "lineNbr": 17,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "I don\u0027t think this is true. https.ListenAndServe calls serverutil.Shutdown() which won\u0027t return until any other running call of serverutil.Shutdown() returns (because of the sync.Once)",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0813e9aa_1619846a",
        "filename": "/COMMIT_MSG",
        "patchSetId": 10
      },
      "lineNbr": 17,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Done",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "5722b761_dbe6f50b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 10
      },
      "lineNbr": 18,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "immediately\nexits",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c9c32696_a4325241",
        "filename": "/COMMIT_MSG",
        "patchSetId": 10
      },
      "lineNbr": 18,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Done",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "8d619819_75f42f9a",
        "filename": "cloud/https/https.go",
        "patchSetId": 10
      },
      "lineNbr": 73,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "mention that it calls serverutil.Shutdown",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "19a89ddd_f1494532",
        "filename": "cloud/https/https.go",
        "patchSetId": 10
      },
      "lineNbr": 73,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Done",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fa2ba447_46dba173",
        "filename": "dir/server/server.go",
        "patchSetId": 10
      },
      "lineNbr": 903,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "shouldn\u0027t this be Close ?",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "957538e4_0c5a6889",
        "filename": "dir/server/server.go",
        "patchSetId": 10
      },
      "lineNbr": 903,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Strictly speaking, Close closes the service *instance*, not all instances. Shutdown is more blunt.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "2a22348e_071b4648",
        "filename": "dir/server/server.go",
        "patchSetId": 10
      },
      "lineNbr": 905,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "for {\n  k, v, next :\u003d it.GetAndAdvance()\n  if !next {\n    return\n  }\n  ...\n}",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "11166a53_69dcb7fa",
        "filename": "dir/server/server.go",
        "patchSetId": 10
      },
      "lineNbr": 905,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Done",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "79a50980_5f6af5a2",
        "filename": "dir/server/server.go",
        "patchSetId": 10
      },
      "lineNbr": 910,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "op",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "bb064d4e_193f97ed",
        "filename": "dir/server/server.go",
        "patchSetId": 10
      },
      "lineNbr": 910,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Done",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "580d28e6_2553ad81",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 17,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "function",
      "range": {
        "startLine": 17,
        "startChar": 45,
        "endLine": 17,
        "endChar": 52
      },
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a5f0a4df_46a542b1",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 17,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Done",
      "range": {
        "startLine": 17,
        "startChar": 45,
        "endLine": 17,
        "endChar": 52
      },
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a6599875_2911911d",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "do we really need priorities? can\u0027t we just do them last-in-first-out order?",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "0b6b7b67_d21fa43d",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "This should work with any init function ordering. In this CL, the 3 shutdown functions I use are registered out of order.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "d436f84b_9114bfbf",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-02T00:58:53Z",
      "side": 1,
      "message": "How so? What is registered and in which order?",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "074f4e1f_942859aa",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T01:50:13Z",
      "side": 1,
      "message": "It\u0027s all in this CL: the log calls flush as the last thing (priority 255). https closes the listener as first thing (priority 0). Then the dirserver flushes all trees -- this one does not matter so I picked order 5.\n\nRight now, by accident, they appear to get registered in the reverse execution order. But I can\u0027t guarantee that there won\u0027t be another init function somewhere else. It\u0027s just not robust enough to let registration order dictate the shutdown order. If order is not important for some of these, then we can always pick some arbitrary number (119 or 127). But when it\u0027s relevant, like log and https, the priority should be there.\n\nIf we want to complicate the logic to save storage space, we can define three levels: First, DontCare and Last. If two or more things must be First or Last, they would compete. \n\nBut I\u0027d hate to have to add two or three more levels later on just to break a tie, so 256 levels seems like a reasonable choice and the space wasted is that of a few pointers. \n\nWe can always change it later if our experience shows that reverse order is all we ever need. For now, I prefer to have explicit control.\n\nThanks.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a6690dc2_f7f6ed78",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-02T04:44:23Z",
      "side": 1,
      "message": "It\u0027s not an accident that they are declared in that order. It\u0027s because that\u0027s the order in which the dependencies are set up, so it is natural that they should be torn down in reverse order. \n\nRight now it\u0027s log \u003c- dir/server \u003c- https. If any other dependency needs to shut down later, it\u0027ll be set up as needed in dependency order, and so the shutdown will happen in the reverse order.\n\nRather than complicate the design with priorities off the bat, why don\u0027t we wait until we have an actual need for them? They\u0027re not necessary now and I\u0027d gamble that they won\u0027t be necessary later.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "33186516_a3235422",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T05:22:52Z",
      "side": 1,
      "message": "If we have multiple init functions registering shutdown handlers, we may need to specify priorities. In my last reply I explained that I want that flexibility now while I\u0027m still deploying this to the rest of the code. Removing it later is just as simple as adding it.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7b11600a_a443db42",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-02T05:27:52Z",
      "side": 1,
      "message": "Well if you\u0027re committed to removing it after you find it unnecessary, then that\u0027s fine with me.\n\nSeems easier not to introduce it in the first place, though. I really don\u0027t think you\u0027ll need it.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "cf3a61ee_0c18d5e2",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T16:49:32Z",
      "side": 1,
      "message": "Thanks. It will be important for metrics, which we should flush second-to-last, just before the logs.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "50cf2686_d4a8f7b9",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 27,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-02T22:24:16Z",
      "side": 1,
      "message": "And metrics will register its shutdown function at init time, before any of the other services, but before log. It just works. ;-)",
      "parentUuid": "cf3a61ee_0c18d5e2",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f5e42b98_8e45743a",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 39,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-02T00:58:53Z",
      "side": 1,
      "message": "var shutdown struct {\n...\n}",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "70329b49_3565ae1e",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 39,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T01:50:13Z",
      "side": 1,
      "message": "Done",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "64585ff3_1fd69307",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 52,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "delete",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "6f9669cb_30d4dbcc",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 52,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "Why? This is very important.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "68370ead_ad2403db",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 73,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "what\u0027s this for?",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "f0abb3ed_ea5c69b5",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 73,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "No longer necessary, as you pointed out in the CL description. I thought the second call to once didn\u0027t wait for the first one to complete and would just return. But as you pointed out -- and I now tested it -- once waits for the first one to complete.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "ef841ce9_5177be03",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 92,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-01T21:44:26Z",
      "side": 1,
      "message": "shutdown.once.Do(shutdown)",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "982aa739_e1b49d11",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 92,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T00:01:17Z",
      "side": 1,
      "message": "No, because Shutdown() calls doShutdown.",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "821bf77b_caa139f6",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 92,
      "author": {
        "id": 5020
      },
      "writtenOn": "2017-02-02T00:58:53Z",
      "side": 1,
      "message": "Then make the body of Shutdown be simply\n\n   shutdown.once.Do(doShutdown)\n\nand then here just call Shutdown",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "26e46d52_ed7ca390",
        "filename": "serverutil/shutdown.go",
        "patchSetId": 10
      },
      "lineNbr": 92,
      "author": {
        "id": 5015
      },
      "writtenOn": "2017-02-02T01:50:13Z",
      "side": 1,
      "message": "Done",
      "revId": "d714aff9e12d078d87f5ffbac53decba68fc3e6a",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    }
  ]
}