{
  "comments": [
    {
      "key": {
        "uuid": "6d241f48_1ff2c75f",
        "filename": "dir/server/tree/tree.go",
        "patchSetId": 5
      },
      "lineNbr": 239,
      "author": {
        "id": 5305
      },
      "writtenOn": "2017-07-02T23:51:10Z",
      "side": 1,
      "message": "why is err being dropped? in fact, why not just drop this clause altogether?",
      "revId": "97a8b543df20924bc9dd32932216c0c267d6d18b",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "aed59154_acb1d0ba",
        "filename": "dir/server/tree/tree.go",
        "patchSetId": 5
      },
      "lineNbr": 239,
      "author": {
        "id": 5389
      },
      "writtenOn": "2017-07-02T23:58:02Z",
      "side": 1,
      "message": "This clause replaces the errfollowlink with a friendlier message that includes the link entry\u0027s name. It\u0027s not strictly necessary for correctness but it would make diagnosing future bugs easier.",
      "parentUuid": "6d241f48_1ff2c75f",
      "revId": "97a8b543df20924bc9dd32932216c0c267d6d18b",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "14aa14f1_5c4bd617",
        "filename": "dir/server/tree/tree.go",
        "patchSetId": 5
      },
      "lineNbr": 267,
      "author": {
        "id": 5308
      },
      "writtenOn": "2017-07-02T16:38:53Z",
      "side": 1,
      "message": "The lack of a log for this is somewhat intentional because PutDir is a different operation than Put. See comment on line 277 below. \n\nThe purpose of the log is two-fold:\n1) so we can re-create this operation if the tree is lost before a flush\n2) for Watch to find the tail.\n\nThis gives the Watch what it needs (#2 above) but not 1. \n\nBy adding this to the log, there\u0027s a very small window of time where you haven\u0027t yet flushed but this is on the log. Hence, if the tree crashes, the recoverFromLog code will attempt to re-apply this Put operation by calling the regular Put. However, it\u0027s not clear to me yet whether it will succeed, since PutDir bypasses some checks that Put does. Hence why I put a comment on line 277 saying we may want to instead add a LogEntry code for PutDir.",
      "revId": "97a8b543df20924bc9dd32932216c0c267d6d18b",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "c60e29cb_1d553ad7",
        "filename": "dir/server/tree/tree.go",
        "patchSetId": 5
      },
      "lineNbr": 267,
      "author": {
        "id": 5389
      },
      "writtenOn": "2017-07-02T21:13:31Z",
      "side": 1,
      "message": "Makes sense. In the interest of forward progress, how about I move the log.Append after the flush in this CL, and we can add the new log operation in a future CL? (ie, fix the todo)",
      "parentUuid": "14aa14f1_5c4bd617",
      "revId": "97a8b543df20924bc9dd32932216c0c267d6d18b",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "251254e7_2e900531",
        "filename": "dir/server/tree/tree.go",
        "patchSetId": 5
      },
      "lineNbr": 267,
      "author": {
        "id": 5308
      },
      "writtenOn": "2017-07-03T05:20:00Z",
      "side": 1,
      "message": "Actually, I thought a bit more about this. It won\u0027t work. You can\u0027t log a PutDir. I will attempt to explain it here, but it might be easier to talk in person. The short story is that the playback for Put will create a new *empty* entry. This one comes with contents. The playback will not be what you expect.\n\nSince this is not really part of fixing the race condition anyway, I would just drop it from this CL for now.\n\nFile a bug against me to have this fixed if it needs fixing. (I say \"if\" here because snapshots have historically been special and I made them a little less special by making them appear in Watch partially -- the parent directory at least. We can choose to make them even less special by adding a PutDir log entry and that should effectively make them behave just like a normal entry).",
      "parentUuid": "c60e29cb_1d553ad7",
      "revId": "97a8b543df20924bc9dd32932216c0c267d6d18b",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fa8b16fa_ea8a5a9d",
        "filename": "dir/server/tree/tree.go",
        "patchSetId": 5
      },
      "lineNbr": 267,
      "author": {
        "id": 5389
      },
      "writtenOn": "2017-07-03T05:26:18Z",
      "side": 1,
      "message": "\u003e I will attempt to explain it here, but it might be easier to talk in person. \n\nI get it, I just assumed that was part of your design.\n\nThe thing is, the fix for the race doesn\u0027t work without writing to the log. If I remove the log append, then the watcher will never see the snapshot being created, and so the test can\u0027t wait for the snapshot to be created in the background. The whole thing would stop working.\n\n\u003e The short story is that the playback for Put will create a new *empty* entry. This one comes with contents. The playback will not be what you expect.\n\nI think this is exactly the same as what would have happened before this change, too. Before this change, the log would have contained a Put for the snapshot directory (since it was being created as an empty directory, before the call to PutDir). Replaying the log, before this change, would have yielded an empty directory too. So I think this CL maintains the status quo, as far as the log contents are concerned.\n\nDoes that make sense to you? If so, should I just leave things as-is, perhaps relocating the TODO in PutDir to be right next to the Append call.",
      "parentUuid": "251254e7_2e900531",
      "revId": "97a8b543df20924bc9dd32932216c0c267d6d18b",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a216edc4_867ea7b6",
        "filename": "dir/server/tree/tree.go",
        "patchSetId": 5
      },
      "lineNbr": 267,
      "author": {
        "id": 5308
      },
      "writtenOn": "2017-07-03T16:54:25Z",
      "side": 1,
      "message": "Yes, I can live with that.",
      "parentUuid": "fa8b16fa_ea8a5a9d",
      "revId": "97a8b543df20924bc9dd32932216c0c267d6d18b",
      "serverId": "0759ed4b-3fdc-34dc-866b-f2e708168c03",
      "unresolved": true
    }
  ]
}